{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container py-5 text-white">
  <h2 class="mb-4">Checkout</h2>

  <!-- Order Summary -->
  <div class="mb-4">
    <h4>Order Summary</h4>
    <ul class="list-group">
      {% for item in cart %}
        <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white">
          {{ item.product.name }} (x{{ item.quantity }})
          <span>£{{ item.total_price }}</span>
        </li>
      {% endfor %}
      <li class="list-group-item d-flex justify-content-between bg-secondary text-white fw-bold">
        Total:
        <span>£{{ cart.get_total_price }}</span>
      </li>
    </ul>
  </div>

  <!-- Checkout Form -->
 <form id="payment-form" method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button id="checkout-button" class="btn btn-success mt-3" type="button">Pay with Card</button>
</form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

  document.getElementById("checkout-button").addEventListener("click", function () {
    // Get form field values
    const fullName = document.getElementById("id_full_name").value;
    const email = document.getElementById("id_email").value;
    const address = document.getElementById("id_address").value;
    const city = document.getElementById("id_city").value;
    const postalCode = document.getElementById("id_postal_code").value;
    const country = document.getElementById("id_country").value;
    const paymentMethod = document.getElementById("id_payment_method").value;

    fetch("{% url 'create_checkout_session' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        full_name: fullName,
        email: email,
        address: address,
        city: city,
        postal_code: postalCode,
        country: country,
        payment_method: paymentMethod
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.id) {
        return stripe.redirectToCheckout({ sessionId: data.id });
      } else {
        alert("Something went wrong.");
      }
    })
    .catch(error => {
      console.error("Error:", error);
      alert("Something went wrong.");
    });
  });
</script>

{% endblock %}
