{% extends "base.html" %}
{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container py-5 text-white">
  <h2 class="mb-4">Checkout</h2>

  <!-- Order Summary -->
  <div class="mb-4">
    <h4>Order Summary</h4>
    <ul class="list-group">
      {% for item in cart %}
        <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white">
          {{ item.product.name }} (x{{ item.quantity }})
          <span>£{{ item.total_price }}</span>
        </li>
      {% endfor %}
      <li class="list-group-item d-flex justify-content-between bg-secondary text-white fw-bold">
        Total:
        <span>£{{ cart.get_total_price }}</span>
      </li>
    </ul>
  </div>

  <!-- Checkout Form -->
 <form id="payment-form" method="POST">
    {% csrf_token %}
    {{ form.as_p }}
    <button id="checkout-button" class="btn btn-success mt-3" type="button">Pay with Card</button>
</form>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
    const stripe = Stripe("{{ STRIPE_PUBLIC_KEY }}");

    document.getElementById("checkout-button").addEventListener("click", function () {
        fetch("{% url 'create_checkout_session' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json"
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                return stripe.redirectToCheckout({ sessionId: data.id });
            } else {
                alert("Something went wrong.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    });
</script>

{% endblock %}
